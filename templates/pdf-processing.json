{
  "id": "pdf-processing",
  "name": "PDF Processing with AI Summary",
  "description": "Extract document text with Docling OCR and generate AI summary using Map-Reduce for large documents",
  "icon": "file",
  "workflow": {
    "name": "PDF Processing with AI Summary",
    "nodes": [
      {
        "parameters": {},
        "name": "When clicking 'Test workflow'",
        "type": "n8n-nodes-base.manualTrigger",
        "typeVersion": 1,
        "position": [240, 300]
      },
      {
        "parameters": {
          "filterType": "documents"
        },
        "name": "File Selector",
        "type": "CUSTOM.fileSelector",
        "typeVersion": 1,
        "position": [440, 300],
        "notesInFlow": true,
        "notes": "Select a PDF or document file to process"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "{{DOCLING_API_URL}}/process",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Authorization",
                "value": "Bearer {{DOCLING_AUTH_TOKEN}}"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ JSON.stringify({ file_path: $json.files[0].path, options: { include_page_markers: false } }) }}",
          "options": {}
        },
        "name": "Submit to Docling",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [640, 300]
      },
      {
        "parameters": {
          "jsCode": "// Extract job_id from response\nconst response = $input.first().json;\nif (!response.job_id) {\n  throw new Error('No job_id returned from Docling');\n}\nreturn [{ json: { \n  job_id: response.job_id, \n  status: response.status\n} }];"
        },
        "name": "Extract Job ID",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [840, 300]
      },
      {
        "parameters": {
          "method": "GET",
          "url": "={{\"{{DOCLING_API_URL}}/jobs/\" + $json.job_id}}",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Authorization",
                "value": "Bearer {{DOCLING_AUTH_TOKEN}}"
              }
            ]
          },
          "options": {}
        },
        "name": "Poll Job Status",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [1040, 300]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "check-completed",
                "leftValue": "={{ $json.status }}",
                "rightValue": "completed",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "name": "Is Completed?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [1240, 300]
      },
      {
        "parameters": {
          "amount": 2,
          "unit": "seconds"
        },
        "name": "Wait",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [1440, 400],
        "webhookId": "docling-wait"
      },
      {
        "parameters": {
          "jsCode": "// Extract the markdown result from completed job\nconst job = $input.first().json;\n\nif (job.status === 'failed') {\n  return [{\n    json: {\n      error: 'Processing failed',\n      message: job.error || 'Unknown error',\n      error_type: job.error_type\n    }\n  }];\n}\n\nconst result = job.result || {};\nreturn [{\n  json: {\n    markdown: result.markdown || '',\n    metadata: result.metadata || {},\n    status: result.status,\n    job_id: job.job_id,\n    file_path: job.file_path\n  }\n}];"
        },
        "name": "Process Result",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [1440, 200]
      },
      {
        "parameters": {
          "operationMode": "documentLoader",
          "options": {
            "summarizationMethodAndPrompts": {
              "values": {
                "summarizationMethod": "map_reduce",
                "combineMapPrompt": "Write a concise summary of the following text:\n\n\"{text}\"\n\nCONCISE SUMMARY:",
                "prompt": "Write a comprehensive summary from these partial summaries:\n\n\"{text}\"\n\nThe summary should include:\n1. A brief overview (2-3 sentences)\n2. Key points (bullet list)\n3. Main topics covered\n\nFINAL SUMMARY:"
              }
            }
          }
        },
        "name": "Summarization Chain",
        "type": "@n8n/n8n-nodes-langchain.chainSummarization",
        "typeVersion": 2,
        "position": [1640, 200]
      },
      {
        "parameters": {
          "model": "gpt-4o-mini",
          "options": {
            "timeout": 120000
          }
        },
        "name": "OpenAI Chat Model",
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1,
        "position": [1540, 400]
      },
      {
        "parameters": {
          "jsonMode": "expressionData",
          "jsonData": "={{ $json.markdown }}",
          "options": {}
        },
        "name": "Default Data Loader",
        "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
        "typeVersion": 1,
        "position": [1640, 400]
      },
      {
        "parameters": {
          "chunkSize": 4000,
          "chunkOverlap": 400,
          "options": {}
        },
        "name": "Recursive Character Text Splitter",
        "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
        "typeVersion": 1,
        "position": [1740, 520]
      },
      {
        "parameters": {
          "mode": "markdownToHtml",
          "markdown": "={{ $json.response.text }}",
          "options": {}
        },
        "name": "Markdown to HTML",
        "type": "n8n-nodes-base.markdown",
        "typeVersion": 1,
        "position": [1840, 200]
      },
      {
        "parameters": {
          "jsCode": "// Format the final output with both HTML and original markdown\nconst html = $input.first().json.data || '';\nconst summaryChainOutput = $('Summarization Chain').first().json;\nconst processResult = $('Process Result').first().json;\n\n// Handle case where summarization may have failed or been refused\nlet summaryText = '';\nif (summaryChainOutput.response && summaryChainOutput.response.text) {\n  summaryText = summaryChainOutput.response.text;\n} else if (summaryChainOutput.text) {\n  summaryText = summaryChainOutput.text;\n} else if (typeof summaryChainOutput === 'string') {\n  summaryText = summaryChainOutput;\n}\n\n// Check if the summary contains a refusal message\nconst isRefusal = summaryText.toLowerCase().includes(\"can't assist\") || \n                  summaryText.toLowerCase().includes(\"cannot assist\") ||\n                  summaryText.toLowerCase().includes(\"i'm not able\");\n\nif (isRefusal || !summaryText) {\n  // If summarization failed, return the original document excerpt\n  const excerpt = (processResult.markdown || '').substring(0, 2000);\n  return [{\n    json: {\n      output: '## Summary Not Available\\n\\nThe AI was unable to generate a summary for this document.\\n\\n### Document Preview\\n\\n' + excerpt + (processResult.markdown?.length > 2000 ? '\\n\\n*[Document truncated...]*' : ''),\n      summary_markdown: null,\n      original_document: processResult.markdown,\n      metadata: processResult.metadata,\n      error: 'Summarization failed or was refused by the AI model'\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    output: summaryText,\n    summary_html: html,\n    summary_markdown: summaryText,\n    original_document: processResult.markdown,\n    metadata: processResult.metadata\n  }\n}];"
        },
        "name": "Format Output",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [2040, 200]
      },
      {
        "parameters": {
          "outputType": "text",
          "contentSource": "auto",
          "fallbackText": "No summary generated. The AI model may have refused to process this document.",
          "textOptions": {
            "renderMarkdown": true,
            "sanitizeHtml": true
          }
        },
        "name": "Result Display",
        "type": "CUSTOM.resultDisplay",
        "typeVersion": 1,
        "position": [2240, 200],
        "notesInFlow": true,
        "notes": "Displays the document summary in the popup"
      }
    ],
    "connections": {
      "When clicking 'Test workflow'": {
        "main": [
          [
            {
              "node": "File Selector",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "File Selector": {
        "main": [
          [
            {
              "node": "Submit to Docling",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Submit to Docling": {
        "main": [
          [
            {
              "node": "Extract Job ID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract Job ID": {
        "main": [
          [
            {
              "node": "Poll Job Status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Poll Job Status": {
        "main": [
          [
            {
              "node": "Is Completed?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Is Completed?": {
        "main": [
          [
            {
              "node": "Process Result",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Wait",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait": {
        "main": [
          [
            {
              "node": "Poll Job Status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Process Result": {
        "main": [
          [
            {
              "node": "Summarization Chain",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model": {
        "ai_languageModel": [
          [
            {
              "node": "Summarization Chain",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Default Data Loader": {
        "ai_document": [
          [
            {
              "node": "Summarization Chain",
              "type": "ai_document",
              "index": 0
            }
          ]
        ]
      },
      "Recursive Character Text Splitter": {
        "ai_textSplitter": [
          [
            {
              "node": "Default Data Loader",
              "type": "ai_textSplitter",
              "index": 0
            }
          ]
        ]
      },
      "Summarization Chain": {
        "main": [
          [
            {
              "node": "Markdown to HTML",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Markdown to HTML": {
        "main": [
          [
            {
              "node": "Format Output",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format Output": {
        "main": [
          [
            {
              "node": "Result Display",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "settings": {
      "executionOrder": "v1"
    }
  }
}
