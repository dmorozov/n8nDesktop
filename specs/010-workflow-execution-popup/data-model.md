# Data Model: Workflow Execution Popup

**Feature**: 010-workflow-execution-popup
**Date**: 2025-12-10

## Entities

### WorkflowPopupConfig

Configuration for a workflow's execution popup, persisted in electron-store.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| workflowId | string | Unique identifier from n8n | Required, primary key |
| workflowName | string | Display name of the workflow | Required |
| lastUpdated | ISO8601 string | Last modification timestamp | Required |
| inputs | Record<string, InputFieldConfig> | Input field configurations keyed by node ID | Required |
| lastExecution | ExecutionResult \| null | Most recent execution result | Optional |

### InputFieldConfig

Definition of an input field in the popup.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| nodeId | string | n8n node identifier | Required |
| nodeType | 'promptInput' \| 'fileSelector' | Type of input node | Required, enum |
| nodeName | string | Display name from node | Required |
| value | string \| FileReference[] | Current input value | Type depends on nodeType |
| required | boolean | Whether input is required | Default: false |

### FileReference

Reference to a selected file.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| id | string | Unique identifier (UUID) | Required |
| path | string | Absolute file path | Required |
| name | string | Original filename | Required |
| size | number | File size in bytes | Required, >= 0 |
| mimeType | string | MIME type | Required |
| selectedAt | ISO8601 string | When file was selected | Required |

### ExecutionResult

Result from a workflow execution.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| executionId | string | n8n execution identifier | Required |
| status | 'success' \| 'error' \| 'timeout' | Execution outcome | Required, enum |
| startedAt | ISO8601 string | Execution start time | Required |
| completedAt | ISO8601 string | Execution end time | Required |
| durationMs | number | Execution duration | Required, >= 0 |
| outputs | OutputResult[] | Results from ResultDisplay nodes | Required |
| error | string \| null | Error message if failed | Optional |

### OutputResult

Output from a ResultDisplay node.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| nodeId | string | ResultDisplay node identifier | Required |
| nodeName | string | Display name from node | Required |
| contentType | 'markdown' \| 'text' \| 'file' | Type of output content | Required, enum |
| content | string | Markdown/text content | Required if markdown/text |
| fileReference | OutputFileReference \| null | File output reference | Required if file |

### OutputFileReference

Reference to a file generated by workflow.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| path | string | Absolute file path | Required |
| name | string | Suggested filename | Required |
| size | number | File size in bytes | Required, >= 0 |
| mimeType | string | MIME type | Required |

### ExecutionState

Runtime state for workflow execution (in-memory, not persisted).

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| status | 'idle' \| 'running' \| 'completed' \| 'failed' | Current state | Required, enum |
| workflowId | string \| null | Currently executing workflow | Required when running |
| executionId | string \| null | n8n execution ID | Required when running |
| progress | number | Execution progress 0-100 | Optional |
| error | string \| null | Error message | Required when failed |

## Relationships

```
WorkflowPopupConfig
├── inputs: Record<nodeId, InputFieldConfig>
│   └── InputFieldConfig
│       └── value (if fileSelector): FileReference[]
└── lastExecution: ExecutionResult
    └── outputs: OutputResult[]
        └── fileReference: OutputFileReference
```

## State Transitions

### ExecutionState Transitions

```
┌─────────┐
│  idle   │
└────┬────┘
     │ execute()
     ▼
┌─────────┐
│ running │◄──────────────────┐
└────┬────┘                   │
     │                        │ retry()
     ├── success ──► completed
     │
     └── error/timeout ──► failed
```

### Valid Transitions:
- `idle` → `running`: User clicks Execute button
- `running` → `completed`: Execution succeeds within timeout
- `running` → `failed`: Execution fails or times out
- `completed` → `idle`: User starts new execution
- `failed` → `idle`: User starts new execution
- `failed` → `running`: User retries (same as new execution)

## Validation Rules

### InputFieldConfig
- If `nodeType === 'promptInput'`: `value` must be string
- If `nodeType === 'fileSelector'`: `value` must be FileReference[]
- If `required === true` and `nodeType === 'promptInput'`: `value.trim().length > 0`
- If `required === true` and `nodeType === 'fileSelector'`: `value.length > 0`

### FileReference
- `path` must be absolute and exist on filesystem
- `size` must match actual file size (validate before execution)
- Maximum 10 files per FileSelector (SC-005)

### ExecutionResult
- `durationMs` must equal `completedAt - startedAt` in milliseconds
- If `status === 'error'`: `error` must not be null
- If `status === 'timeout'`: `durationMs` should be ~300000 (5 minutes)

## Storage Schema (electron-store)

```json
{
  "popupConfigs": {
    "workflow-uuid-1": {
      "workflowId": "workflow-uuid-1",
      "workflowName": "Document Processor",
      "lastUpdated": "2025-12-10T10:30:00Z",
      "inputs": {
        "node-uuid-prompt": {
          "nodeId": "node-uuid-prompt",
          "nodeType": "promptInput",
          "nodeName": "Instructions",
          "value": "Summarize this document",
          "required": true
        },
        "node-uuid-files": {
          "nodeId": "node-uuid-files",
          "nodeType": "fileSelector",
          "nodeName": "Documents",
          "value": [
            {
              "id": "file-uuid-1",
              "path": "/home/user/documents/report.pdf",
              "name": "report.pdf",
              "size": 1024000,
              "mimeType": "application/pdf",
              "selectedAt": "2025-12-10T10:25:00Z"
            }
          ],
          "required": true
        }
      },
      "lastExecution": {
        "executionId": "exec-uuid-1",
        "status": "success",
        "startedAt": "2025-12-10T10:30:00Z",
        "completedAt": "2025-12-10T10:30:45Z",
        "durationMs": 45000,
        "outputs": [
          {
            "nodeId": "node-uuid-result",
            "nodeName": "Summary Output",
            "contentType": "markdown",
            "content": "# Document Summary\n\nThis report covers...",
            "fileReference": null
          }
        ],
        "error": null
      }
    }
  }
}
```

## Migration Notes

This is a new feature with no existing data to migrate. The electron-store schema will be created on first use.
